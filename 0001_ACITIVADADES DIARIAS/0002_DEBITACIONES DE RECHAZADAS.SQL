--PASOS QUE SE USAN PARA LAS DEBITACIONES EN CONJUNTO CON EL PROCESO DE RODRIGO

---PASO 1 COLOCAR LOS REGISTROS QUE VAN A SER DEBITADOS A LA TABLA DE SINCRONIZADOR.AJUSTEDEB
---PASO 2 EJECUTAR EL SCRIPT SIGUIENTE
----------------------------
MERGE INTO SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC NFC USING (
    SELECT
    UIDDETALLESINCRONIZADOR, NVAFECHAPROCESAR NVA_FECHAOPERACION
    , INUMEROTARJETA, STIPOTARIFA, DMONTOCOBRADO ,NVODMONTOCOBRADO AS NVO_DMONTOCOBRADO, ICONTADORTRANSACCIONES, IFOLIO+1 AS NVO_CONTADORTRANSACCIONES
    ,DTFECHACREACION,
    CASE WHEN EXTRACT(MONTH from DTFECHACREACION) < EXTRACT(MONTH from SYSDATE)THEN
    NVAFECHAPROCESAR ELSE DTFECHACREACION END NVA_DTFECHACREACION
    ,LOADTRANSCOUNTER, LTC NVO_LOADTRANSCOUNTER,
    IERROR,
    0 NVO_IERROR, BPROCESADO, TRANSBORDO, SINCIDENCIA AS NVAINCIDENCIA
    FROM SINCRONIZADOR.AJUSTEDEB DEB
    INNER JOIN (SELECT INUMEROTARJETA TARJETA, MAX(ICONTADORTRANSACCIONES) IFOLIO, MAX(LOADTRANSCOUNTER) LTC FROM SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC GROUP BY INUMEROTARJETA) T ON T.TARJETA = DEB.INUMEROTARJETA
    WHERE BPROCESADO = 0
) DEB ON (DEB.UIDDETALLESINCRONIZADOR = NFC.UIDDETALLESINCRONIZADOR)
WHEN MATCHED THEN UPDATE
SET DTFECHAOPERACION = NVA_FECHAOPERACION,
DMONTOCOBRADO = NVO_DMONTOCOBRADO,
ICONTADORTRANSACCIONES = NVO_CONTADORTRANSACCIONES,
DTFECHACREACION = NVA_DTFECHACREACION,
LOADTRANSCOUNTER = NVO_LOADTRANSCOUNTER,
IERROR = NVO_IERROR,
BPROCESADO = 0,
BDEBITADO = 0,
SINCIDENCIA = NVAINCIDENCIA,
ITRANSBORDO = TRANSBORDO,
TOKENTRANSACCION = CASE 
    WHEN NVL(TOKENTRANSACCION,'00000000000000000000000000000000') = '00000000000000000000000000000000' 
    THEN SUBSTR(RAWTOHEX(DBMS_RANDOM.VALUE(0, POWER(2, 64))),1, 32)
    ELSE TOKENTRANSACCION END
WHERE (DEB.UIDDETALLESINCRONIZADOR = NFC.UIDDETALLESINCRONIZADOR);
COMMIT;
----------------------------------------
----PASO 3 LOCALIZAR EL SIGUIENTE ENDPOINT /transactions/debitos/reporcesar
-- -- Y EJECUTARLO DENTRO DEL SWAGGER,
----PASO 4 VIGILAR EL CMD PARA VERIFICAR LAS TRANSACCIONES QUE SE ESTAN PROCESANDO









