

SELECT M.INUMEROMONEDERO, M.INUMEROTARJETA,E.SESTATUS,E.STIPOTARIFA, M.ICONTADORRECARGA, M.ICONTADORRECARGAAPLICADA,A.ULTIMOLTC, XX.loadtranscounter2,E.DSALDO,TO_CHAR(XX.SALDO, '999,999.00') SALDO,
CASE WHEN XX.SALDO < 0 THEN 'SIN SALDO' ELSE 'CON SALDO NFC' END AS clasificacion
,XX.IERROR,XX.DTFECHAOPERACION, 
case when V.UIDTARJETA is null then 'Sin App' else 'Vinculado App' end VinculacionApp
from sincronizador.monedero M
INNER JOIN MONEDEROCONSULTAS.ESTADODECUENTA E ON E.UIDMONEDERO = M.UIDMONEDERO
LEFT JOIN (SELECT STARJETA, MAX(ICONTADORRECARGA) ULTIMOLTC, SUM(DSALDOACTUAL) TOTAL_CM FROM sincronizador.cambiosmonedero GROUP BY STARJETA) A ON A.STARJETA = M.INUMEROTARJETA
INNER JOIN (
select inumerotarjeta,
   MAX(DTFECHAOPERACION) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS DTFECHAOPERACION
  ,MAX(DSALDO) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS SALDO
  ,MAX(IERROR) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS IERROR
  ,MAX(loadtranscounter)  AS loadtranscounter2
  FROM SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC
  WHERE  1=1
  AND  SINCIDENCIA not like 'DEB. PEND.%'-->CORRECCION A NIVEL DATOS PORQUE NO DEBE TOMAR LOS REPROCESOS QUE HAYAMOS HECHO
  AND  SINCIDENCIA not like 'SIM. DEB. PEND.%'-->CONDICION PARA EVITAR AGARRAR LOS QUE SEAN REPROCESOS
  GROUP BY inumerotarjeta
) XX ON XX.inumerotarjeta = M.inumerotarjeta
LEFT JOIN (
SELECT DISTINCT am.UIDTARJETA
FROM APPMONEDEROCOMMAND.TARJETAUSUARIO AM
INNER JOIN APPMONEDEROCOMMAND.ESTADODECUENTA AE ON AE.UIDMONEDERO = AM.UIDMONEDERO
INNER JOIN APPMONEDEROCOMMAND.USUARIO USU ON USU.UIDUSUARIO = AM.UIDUSUARIO
INNER JOIN APP.USUARIO USU2 ON USU2.UIDUSUARIO = usu.UIDUSUARIO
WHERE
1=1
AND USU2.BBAJA = 0
AND AM.BACTIVO = 1
) V ON V.UIDTARJETA = E.UIDTARJETA
--INNER JOIN (SELECT UIDMONEDERO, SUM(DMONTO) IMPABONO, COUNT(0) TOTALABONOS FROM MONEDEROCONSULTAS.MOVIMIENTOS WHERE STIPOMOVIMIENTO = 'ABONO' GROUP BY UIDMONEDERO)
--X ON X.UIDMONEDERO = E.UIDMONEDERO
where 1=1
and A.ULTIMOLTC = XX.loadtranscounter2
and E.DSALDO > XX.SALDO
AND E.DSALDO > 0
AND E.SESTATUS = 'ACTIVO'
--AND E.INUMTARJETA IN (
--5000000000911939,5000000000697366,5000000000119941,5000000000331214,5000000000916820,5000000000466182,5000000000708322,5000000000630874,5000000000555326,5000000000644200,5000000000625029,5000000000709538,5000000000148702,5000000000638949,5000000000401757,5000000000432869,5000000000144465,5000000000073970,5000000000382571,5000000000109626,5000000000630768,5000000000194357,5000000000342343,5000000000616269,5000000000885301,5000000000240491,5000000000248054,5000000000582246,5000000000146980,5000000000277737,5000000000428804,5000000000357714,5000000000160025,5000000000934816,5000000000602362,5000000000280277,5000000000711089,5000000000939117,5000000000159832
--)
--AND V.UIDTARJETA IS NULL
AND TOTAL_CM IS NOT NULL
and M.INUMEROTARJETA not in (select inumerotarjeta from SINCRONIZADOR.AJUSTEDEB)
--and m.inumerotarjeta = 5000000000358746
;


------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------