SELECT t1.UIDORDEN, t1.UIDMONEDERO, t4.INUMEROTARJETA
FROM PAGOS.ORDENES t1
         inner join SINCRONIZADOR.MONEDERO t4 on t1.UIDMONEDERO = t4.UIDMONEDERO
         left join MONEDEROCOMANDOS.MOVIMIENTOSESTADOSDECUENTA t2 on t1.UIDORDEN = t2.UIDOPERACION
         left join MONEDEROCONSULTAS.MOVIMIENTOS t3 on t1.UIDORDEN = t3.UIDOPERACION
-- WHERE TRUNC(t1.DTFECHAOPERACION) = TRUNC(TO_DATE('19/09/2025'))
WHERE TRUNC(t1.DTFECHAOPERACION) >= to_date('19/09/2025 00:00:00', 'DD/MM/YYYY HH24:MI:SS')
  and t1.IOPCION_PAGO <> 4
--   and t1.ESTATUSPROCESO in (2, 3)
  and t1.ESTATUSPROCESO <> 1
  and (t2.UIDOPERACION is null or t3.UIDOPERACION is null);



select count(1)
from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
where t1.IERROR = 0
  AND LOADTRANSCOUNTER = 0


select *
from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
where t1.INUMEROTARJETA = '5000000000945726'
order by t1.DTFECHAOPERACION desc;



with Tarjetas_Hoy as (select t1.INUMEROTARJETA
                          t1.LOADTRANSCOUNTER KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION desc) AS DTFECHAOPERACION

                      from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
                      where 1 = 1
                        AND DTFECHAOPERACION < TO_DATE('19/09/2025 15:00:00', 'DD/MM/YYYY HH24:MI:SS'),

-- AND     t1.INUMEROTARJETA = '5000000000945726'
                        and IERROR = 0
                      group by t1.INUMEROTARJETA),
     TOP_LTC AS (SELECT INUMEROTARJETA, max(LOADTRANSCOUNTER) LOADTRANSCOUNTER
                 from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
                 WHERE 1 = 1
                 group by INUMEROTARJETA)
SELECT T1.INUMEROTARJETA, T2.LOADTRANSCOUNTER, t3.ICONTADORRECARGA, t3.ICONTADORRECARGAAPLICADA
FROM Tarjetas_Hoy T1
         JOIN TOP_LTC T2 ON T1.INUMEROTARJETA = T2.INUMEROTARJETA
         JOIN SINCRONIZADOR.MONEDERO t3 on t1.INUMEROTARJETA = t3.INUMEROTARJETA
where t2.LOADTRANSCOUNTER <> t3.ICONTADORRECARGA;



select t1.INUMEROTARJETA, max(LOADTRANSCOUNTER), t2.ICONTADORRECARGA, t2.ICONTADORRECARGAAPLICADA
from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
         join SINCRONIZADOR.MONEDERO t2 on t1.INUMEROTARJETA = t2.INUMEROTARJETA
where t1.IERROR = 0
  and LOADTRANSCOUNTER <> 0
  and trunc(t1.DTFECHAOPERACION) = trunc(sysdate - 6 / 24)
group by t2.ICONTADORRECARGA, t2.ICONTADORRECARGAAPLICADA, t1.INUMEROTARJETA;

with tarjetas_ayer as (select t1.INUMEROTARJETA, max(t1.LOADTRANSCOUNTER) LOADTRANSCOUNTER
                       from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
                                join CREDENCIALIZACION.TARJETAS t2 on t1.INUMEROTARJETA = t2.INUMEROTARJETA
                       WHERE TRUNC(t1.DTFECHAOPERACION) = trunc(sysdate - 6 / 24)
                         and t2.BACTIVO = 1
                         and t1.BBAJA = 0
                         and BVENDIDA = 1
                       group by t1.INUMEROTARJETA)
select t1.*, t2.ICONTADORRECARGA, t2.ICONTADORRECARGAAPLICADA
from tarjetas_ayer t1
         join SINCRONIZADOR.MONEDERO t2 on t1.INUMEROTARJETA = t2.INUMEROTARJETA
where t1.LOADTRANSCOUNTER <> t2.ICONTADORRECARGA;



select count(1) cantidad, 'Pagos_Faltantes_CODI'
from pagos.ORDENES PO
         join pagos.PAGOSCODI POC on PO.UIDORDEN = poc.UIDORDEN
         left join SINCRONIZADOR.CAMBIOSMONEDERO t3 on poc.UIDPAGOCODI = t3.IDOPERACION
         left join MONEDEROCOMANDOS.MOVIMIENTOSESTADOSDECUENTA t2 on poc.UIDPAGOCODI = t2.UIDOPERACION
         left join MONEDEROCONSULTAS.MOVIMIENTOS t3 on poc.UIDPAGOCODI = t3.UIDOPERACION
where po.ESTATUSPROCESO <> 1
  and trunc(po.DTFECHAOPERACION) >= trunc(current_timestamp - 1)
  and (t2.UIDOPERACION is null or t3.UIDOPERACION is null)
union all
-- SELECT t1.UIDORDEN, t1.UIDMONEDERO, t4.INUMEROTARJETA
SELECT count(1) cantidad, 'pagos_faltantes'
FROM PAGOS.ORDENES t1
         inner join SINCRONIZADOR.MONEDERO t4 on t1.UIDMONEDERO = t4.UIDMONEDERO
         left join MONEDEROCOMANDOS.MOVIMIENTOSESTADOSDECUENTA t2 on t1.UIDORDEN = t2.UIDOPERACION
         left join MONEDEROCONSULTAS.MOVIMIENTOS t3 on t1.UIDORDEN = t3.UIDOPERACION
-- WHERE TRUNC(t1.DTFECHAOPERACION) = TRUNC(TO_DATE('19/09/2025'))
    and trunc(t1.DTFECHAOPERACION) >= trunc(current_timestamp - 1)
    and t1.IOPCION_PAGO <> 4
--   and t1.ESTATUSPROCESO in (2, 3)
    and t1.ESTATUSPROCESO <> 1
    and (t2.UIDOPERACION is null or t3.UIDOPERACION is null);



select current_timestamp
from dual
;
with A as (select t1.*,
                  ROW_NUMBER() OVER (PARTITION BY t1.INUMEROTARJETA ORDER BY t1.DTFECHAOPERACION DESC) AS RN
           from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
           where 1 = 1
             and trunc(t1.DTFECHAOPERACION) >= trunc(current_timestamp - 2)),
     tarjetas_Sin_LTC as (select *
                          from A
                          where 1 = 1
                            and RN = 1
                            and LOADTRANSCOUNTER = 0
                            and IERROR = 0)
-- ultima_recarga as (
-- select t1.INUMEROTARJETA,t1.LOADTRANSCOUNTER,t2.UIDLISTACUENTAS,t3.ICONTADORRECARGA,t3.ICONTADORRECARGAAPLICADA,
--                   ROW_NUMBER() OVER (PARTITION BY t2.STARJETA ORDER BY t2.ICONTADORRECARGA DESC) AS RN
--        from tarjetas_Sin_LTC t1
--          join SINCRONIZADOR.CAMBIOSMONEDERO t2 on t1.INUMEROTARJETA = t2.STARJETA
--        join sincronizador.MONEDERO t3 on t3.INUMEROTARJETA = t2.STARJETA
--        where
--            1=1
-- --        and t2.UIDLISTACUENTAS <>'00000000-0000-0000-0000-000000000000'
--        and t3.ICONTADORRECARGA <> ICONTADORRECARGAAPLICADA
--     )
select * from tarjetas_Sin_LTC t1
         join sincronizador.MONEDERO t2 on t1.INUMEROTARJETA = t1.INUMEROTARJETA
where 1=1
and rn=1
and t2.ICONTADORRECARGA <> t2.ICONTADORRECARGAAPLICADA;
-- and UIDLISTACUENTAS = '00000000-0000-0000-0000-000000000000';


with tarjetas_ayer as (select t1.INUMEROTARJETA,max(t1.LOADTRANSCOUNTER) LOADTRANSCOUNTER
                       from SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC t1
                       join CREDENCIALIZACION.TARJETAS t2 on t1.INUMEROTARJETA = t2.INUMEROTARJETA
                       WHERE TRUNC(t1.DTFECHAOPERACION) = trunc(sysdate - 6 / 24)
                       and t2.BACTIVO = 1 and t1.BBAJA = 0 and BVENDIDA = 1
                       group by t1.INUMEROTARJETA)
select count(1) from tarjetas_ayer t1
join SINCRONIZADOR.MONEDERO t2 on t1.INUMEROTARJETA= t2.INUMEROTARJETA
where  t1.LOADTRANSCOUNTER <> t2.ICONTADORRECARGA;

select * from sincronizador.CAMBIOSMONEDERO

