--  insert into SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP(INUMEROTARJETA, ICONTADORRECARGA,                                                                ICONTADORRECARGAAPLICADA, DTFECHAINSERCION)
select t1.INUMEROTARJETA, t1.ICONTADORRECARGA, t1.ICONTADORRECARGAAPLICADA, SYSDATE - 6 / 24 as horaInsercion
from SINCRONIZADOR.MONEDERO t1
    join MONEDEROCONSULTAS.ESTADODECUENTA t3 on t1.INUMEROTARJETA = t3.INUMTARJETA
         left join SINCRONIZADOR.CAMBIOSMONEDERO t2
                   on t1.INUMEROTARJETA = t2.STARJETA and t2.ICONTADORRECARGA = t1.ICONTADORRECARGAAPLICADA + 1
where 1 = 1
  AND t1.INUMEROTARJETA in
      (select INUMEROTARJETA from SINCRONIZADOR.RECARGAS_PENDIENTES where BAPLICADA = 1 and BDUPLICADA = 0)
  and t1.INUMEROTARJETA > 0
  and t1.ICONTADORRECARGA > 0
  and t1.ICONTADORRECARGAAPLICADA > 0
  and t1.ICONTADORRECARGA > t1.ICONTADORRECARGAAPLICADA
  and t2.ICONTADORRECARGA is null
 and t3.SESTATUS = 'ACTIVO';
--commit
-- rollback
--
-- CREATE TABLE SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP
-- (
--     INUMEROTARJETA           VARCHAR2(16),
--     ICONTADORRECARGA         number,
--     ICONTADORRECARGAAPLICADA number(38),
--     DTFECHAINSERCION         DATE,
--     BPROCESADO               NUMBER(1) default 0
-- );
-- COMMIT;

select *
from SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP where BPROCESADO = 0;






MERGE INTO SINCRONIZADOR.MONEDERO destino
USING (select *
       from SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP
       where BPROCESADO = 0 ) origen
ON (destino.INUMEROTARJETA = origen.INUMEROTARJETA)
WHEN MATCHED THEN
    update
    set destino.ICONTADORRECARGA = ICONTADORRECARGA - 1;
-- --commit
-- ---------------------------------------------------------------------
MERGE INTO SINCRONIZADOR.CAMBIOSMONEDERO destino
USING (select *
       from SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP
       where BPROCESADO = 0) origen
ON (destino.STARJETA = origen.INUMEROTARJETA)
WHEN MATCHED THEN
    update
    set destino.ICONTADORRECARGA = ICONTADORRECARGA - 1
      , UIDLISTACUENTAS          = '00000000-0000-0000-0000-000000000000'
      , SCRIPTOGRAMARECARGA=''
    where destino.ICONTADORRECARGA > origen.ICONTADORRECARGAAPLICADA;
-- commit;
--
-- update SINCRONIZADOR.TARJETAS_REPARAR_LTCS_SECUENCIA_BKUP set BPROCESADO=1 where BPROCESADO=0;