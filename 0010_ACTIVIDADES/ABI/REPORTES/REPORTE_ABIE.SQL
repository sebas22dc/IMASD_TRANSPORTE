select MOE.INUMMONEDERO,
XW.inumerotarjeta as num_tarjeta,
MOE.SESTATUS,
MOE.DSALDO AS SALDO_MONEDERO,
XW.SALDO as SALDO_TARJETA,
MOE.DTFECHAULTIMAOPERACION AS ULT_DEBITACION,
MOE.DTFECHAULTIMOABONO as ULT_ABONO,
case  when XW.SALDO>0 then 'SI' else 'NO' end as CON_SALDO_TARJETA,
--CASE WHEN EXISTS (
--    SELECT 1
--    FROM APPMONEDEROCOMMAND.TARJETAUSUARIO 
--    WHERE bactivo = 1 AND bbaja = 0 and XW.inumerotarjeta = SNUMEROTARJETA
--  ) THEN 'VINCULADO APP' ELSE 'SIN APP' END AS VINCULADO_APP,
CASE WHEN APT.SNUMEROTARJETA is null THEN 'SIN APP' ELSE 'VINCULADO APP' END AS VINCULADO_APP,
CASE 
WHEN abs(MOE.DSALDO) >=0 and abs(MOE.DSALDO) <=100 THEN '0 - 100'
WHEN abs(MOE.DSALDO) >=101 and abs(MOE.DSALDO) <=300 THEN '101 - 300'
WHEN abs(MOE.DSALDO) >=301 and abs(MOE.DSALDO) <=500 THEN '301 - 500'
ELSE '501 O MAS'
END AS RANGO
from monederoconsultas.estadodecuenta MOE
LEFT JOIN sincronizador.monedero XX on MOE.UIDMONEDERO = XX.UIDMONEDERO
INNER JOIN (
select inumerotarjeta,
MAX(DTFECHAOPERACION) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS DTFECHAOPERACION
,MAX(DSALDO) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS SALDO
,MAX(IERROR) KEEP (DENSE_RANK LAST ORDER BY DTFECHAOPERACION) AS IERROR
,MAX(loadtranscounter) AS loadtranscounter2
FROM SINCRONIZADOR.DETALLESINCRONIZACIONTRANSACCIONESNFC
GROUP BY inumerotarjeta
) XW ON XW.inumerotarjeta = XX.inumerotarjeta
LEFT JOIN APPMONEDEROCOMMAND.TARJETAUSUARIO APT on APT.SNUMEROTARJETA = XW.inumerotarjeta and  APT.bactivo = 1 AND APT.bbaja = 0
where MOE.sEstatus = 'ACTIVO' AND MOE.dSaldo < -12 and XW.inumerotarjeta !=0
and (
MOE.DTFECHAULTIMAOPERACION >= sysdate - 60 or MOE.DTFECHAULTIMOABONO >= sysdate -60 --> validar que el ultimo abono o debitacion sea dentro de los ultimos 60 dias
); 