-- SELECT sql_id,
--        parsing_schema_name AS usuario,
--        to_char(last_active_time - 6/24, 'DD-MM-YYYY HH24:MI:SS') AS ultima_actividad,
--        executions,
--        sql_fulltext 
-- FROM   v$sql
-- WHERE  last_active_time > SYSDATE - (10/1440)  -- últimos 10 minutos
-- AND parsing_schema_name = 'APP'
-- ORDER BY last_active_time DESC;
 




-- SELECT username,
--        account_status,
--        expiry_date,
--        lock_date,
--        profile,
--        created
-- FROM   dba_users
-- ORDER BY username ;

-- conn DOCUMENTACION/DOCUMENTACION$2025

-- ALTER USER DOCUMENTACION IDENTIFIED BY "DOCUMENTACION$2025";





-- -- ALTER TABLE APP.ESTADODECUENTA DISABLE CONSTRAINT SYS_C009980;

-- -- select * from app.usuario;
-- -- SELECT USERNAME, ACCOUNT_STATUS, LOCK_DATE, EXPIRY_DATE, CREATED, PROFILE FROM DBA_USERS WHERE USERNAME = 'USR_DBA_DEV';


-- -- ALTER USER USR_DBA_DEV IDENTIFIED BY "8RgtVT6d";
-- -- contraseña 8RgtVT6d














-- #REAP - SCRIPTS PARA REPLICAS DE TARJETAS Y MONEDEROS

-- TARJETAS NO REPLICADAS (CRED vs APP)
SELECT 
    COUNT(0) AS discrepancias
FROM  CREDENCIALIZACION.TARJETAS t1
LEFT JOIN APP.TARJETAS t2 ON t1.UIDTARJETA = t2.UIDTARJETA
WHERE t1.BVENDIDA = 1 AND t1.BINICIALIZADA = 1 AND t1.BASOCIADA = 1 AND t2.UIDTARJETA IS NULL

-- INSERT PARA REPLICAR TARJETAS EN APP
INSERT INTO APP.TARJETAS (
    UIDTARJETA, INUMEROMONEDERO, INUMEROTARJETA, SVIGENCIA, UIDESTATUSTARJETA, BVENDIDA, 
    BASOCIADA, UIDTIPOTARIFA, BACTIVO, BBAJA, BINICIALIZADA, UIDMONEDERO, UIDMOTIVO
)
SELECT 
	T1.UIDTARJETA, T1.INUMEROMONEDERO, T1.INUMEROTARJETA, T1.SVIGENCIA, T1.UIDESTATUSTARJETA, T1.BVENDIDA, 
	T1.BASOCIADA, T1.UIDTIPOTARIFA, T1.BACTIVO, T1.BBAJA, T1.BINICIALIZADA, T1.UIDMONEDERO, T1.UIDMOTIVO
FROM  CREDENCIALIZACION.TARJETAS T1
LEFT JOIN APP.TARJETAS T2 ON T1.UIDTARJETA = T2.UIDTARJETA
	WHERE T1.BVENDIDA = 1 AND T1.BINICIALIZADA = 1 AND T1.BASOCIADA = 1 AND T2.UIDTARJETA IS NULL;

commit;
-- MONEDEROS NO REPLICADOS EN APP
SELECT
    COUNT(0) AS discrepancias
FROM  MONEDEROCOMANDOS.MONEDERO t1
INNER JOIN MONEDEROCONSULTAS.ESTADODECUENTA e ON t1.UIDMONEDERO = e.UIDMONEDERO 
LEFT JOIN APP.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO 
WHERE t1.BACTIVO = 0 AND t1.BBAJA = 1 AND t2.UIDMONEDERO IS NULL

-- INSERT PARA REPLICAR MONEDEROS NO EN APP
INSERT INTO APP.ESTADODECUENTA (
	UIDESTADODECUENTA, UIDMONEDERO, UIDTIPOTARIFA, UIDULTIMAOPERACION, UIDESTATUS, INUMMONEDERO, DSALDO, STIPOTARIFA, STELEFONO, SESTATUS, BACTIVO, BBAJA, 
	DTFECHAULTIMAOPERACION, DTFECHAULTIMOABONO, DTFECHACREACION, DTFECHABAJA, SNOMBRE, SAPELLIDOPATERNO, SAPELLIDOMATERNO, SCORREO, SFECHAVIGENCIA, DTFECHANACIMIENTO, 
	UIDTIPOMONEDERO, STIPOMONEDERO, INUMTARJETA, UIDMOTIVO, SPANHASH
)
SELECT
	e.UIDESTADODECUENTA, e.UIDMONEDERO, e.UIDTIPOTARIFA, e.UIDULTIMAOPERACION, e.UIDESTATUS, e.INUMMONEDERO, e.DSALDO, e.STIPOTARIFA, e.STELEFONO, e.SESTATUS, e.BACTIVO, e.BBAJA,
	e.DTFECHAULTIMAOPERACION, e.DTFECHAULTIMOABONO, e.DTFECHACREACION, e.DTFECHABAJA, e.SNOMBRE, e.SAPELLIDOPATERNO, e.SAPELLIDOMATERNO, e.SCORREO, e.SFECHAVIGENCIA, e.DTFECHANACIMIENTO,
	e.UIDTIPOMONEDERO, e.STIPOMONEDERO, e.INUMTARJETA, e.UIDMOTIVO, e.SPANHASH
FROM  MONEDEROCOMANDOS.MONEDERO t1
INNER JOIN MONEDEROCONSULTAS.ESTADODECUENTA e ON t1.UIDMONEDERO = e.UIDMONEDERO 
LEFT JOIN APP.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO 
WHERE t1.BACTIVO = 0 AND t1.BBAJA = 1 AND t2.UIDMONEDERO IS NULL

commit;



-- MONEDEROS ACTIVOS NO REPLICADOS EN APP
SELECT
    COUNT(0) AS discrepancias
FROM  MONEDEROCOMANDOS.MONEDERO t1
INNER JOIN MONEDEROCONSULTAS.ESTADODECUENTA e ON t1.UIDMONEDERO = e.UIDMONEDERO 
LEFT JOIN APP.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO 
WHERE t1.BACTIVO = 1 AND t1.BBAJA = 0 AND t2.UIDMONEDERO IS NULL

-- INSERT PARA REPLICAR MONEDEROS ACTIVOS EN APP
INSERT INTO APP.ESTADODECUENTA (
	UIDESTADODECUENTA, UIDMONEDERO, UIDTIPOTARIFA, UIDULTIMAOPERACION, UIDESTATUS, INUMMONEDERO, DSALDO, STIPOTARIFA, STELEFONO, SESTATUS, BACTIVO, BBAJA, 
	DTFECHAULTIMAOPERACION, DTFECHAULTIMOABONO, DTFECHACREACION, DTFECHABAJA, SNOMBRE, SAPELLIDOPATERNO, SAPELLIDOMATERNO, SCORREO, SFECHAVIGENCIA, DTFECHANACIMIENTO, 
	UIDTIPOMONEDERO, STIPOMONEDERO, INUMTARJETA, UIDMOTIVO, SPANHASH
)
SELECT
	e.UIDESTADODECUENTA, e.UIDMONEDERO, e.UIDTIPOTARIFA, e.UIDULTIMAOPERACION, e.UIDESTATUS, e.INUMMONEDERO, e.DSALDO, e.STIPOTARIFA, e.STELEFONO, e.SESTATUS, e.BACTIVO, e.BBAJA,
	e.DTFECHAULTIMAOPERACION, e.DTFECHAULTIMOABONO, e.DTFECHACREACION, e.DTFECHABAJA, e.SNOMBRE, e.SAPELLIDOPATERNO, e.SAPELLIDOMATERNO, e.SCORREO, e.SFECHAVIGENCIA, e.DTFECHANACIMIENTO,
	e.UIDTIPOMONEDERO, e.STIPOMONEDERO, e.INUMTARJETA, e.UIDMOTIVO, e.SPANHASH
FROM  MONEDEROCOMANDOS.MONEDERO t1
INNER JOIN MONEDEROCONSULTAS.ESTADODECUENTA e ON t1.UIDMONEDERO = e.UIDMONEDERO 
LEFT JOIN APP.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO 
WHERE t1.BACTIVO = 1 AND t1.BBAJA = 0 AND t2.UIDMONEDERO IS NULL




MERGE INTO NOTIFICACIONES.USUARIO REPLICA
USING (
SELECT 
t1.uidusuario,
t1.SNOMBRE,
t1.SAPELLIDOPATERNO,
t1.SAPELLIDOMATERNO,
t1.STELEFONO,
t1.SCORREO,
t1.UIDMONEDERO,
t1.SLADA
FROM  APP.USUARIO t1
INNER JOIN NOTIFICACIONES.USUARIO t2 ON t1.UIDUSUARIO = t2.UIDUSUARIO
WHERE t1.BACTIVO = 1 AND t1.BBAJA = 0 AND 
(
t1.SNOMBRE <> t2.SNOMBRE 
OR t1.SAPELLIDOPATERNO <> t2.SAPELLIDOPATERNO 
OR t1.SAPELLIDOMATERNO <> t2.SAPELLIDOMATERNO  
OR t1.STELEFONO <> t2.STELEFONO 
OR t1.SCORREO <> t2.SCORREO 
OR t1.UIDMONEDERO <> t2.UIDMONEDERO 
OR t1.SLADA <> t2.SLADA 
)
) ORIGEN
ON (REPLICA.uidusuario = ORIGEN.uidusuario)
WHEN MATCHED THEN
UPDATE SET
  REPLICA.SNOMBRE = ORIGEN.SNOMBRE,
  REPLICA.SAPELLIDOPATERNO = ORIGEN.SAPELLIDOPATERNO,
  REPLICA.SAPELLIDOMATERNO = ORIGEN.SAPELLIDOMATERNO,
  REPLICA.STELEFONO= ORIGEN.STELEFONO,
  REPLICA.SCORREO= ORIGEN.SCORREO,
  REPLICA.UIDMONEDERO= ORIGEN.UIDMONEDERO,
  REPLICA.SLADA= ORIGEN.SLADA
  ;
  COMMIT;
 


INSERT INTO APP.TIPOSTARIFA (
    UIDTIPOTARIFA, STIPOTARIFA, SCLAVETIPOTARIFA, ITIPOTARJETA
)
SELECT
    t1.UIDTIPOTARIFA, t1.STIPOTARIFA, t1.SCLAVETIPOTARIFA, t1.ITIPOTARJETA
FROM CATALOGOS.TIPOTARIFAS t1
LEFT JOIN APP.TIPOSTARIFA t2 
       ON t1.UIDTIPOTARIFA = t2.UIDTIPOTARIFA
WHERE t1.BACTIVO = 1 AND t1.BBAJA = 0 AND t2.UIDTIPOTARIFA IS NULL;

commit;


SELECT COUNT(0)
FROM PRPE_APPMONEDEROCOMMAND.ESTADODECUENTA t1
INNER JOIN PREP_APPMONEDEROQUERY.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO
WHERE t1.UIDTIPOTARIFA <> t2.UIDTIPOTARIFA OR t1.ITIPOTARJETA <> t2.ITIPOTARJETA;


MERGE INTO PREP_APPMONEDEROQUERY.ESTADODECUENTA dest
USING (
    SELECT T1.UIDMONEDERO, T1.UIDTIPOTARIFA, T1.ITIPOTARJETA
        FROM PREP_APPMONEDEROCOMMAND.ESTADODECUENTA t1
		INNER JOIN PREP_APPMONEDEROQUERY.ESTADODECUENTA t2 ON t1.UIDMONEDERO = t2.UIDMONEDERO
	WHERE t1.UIDTIPOTARIFA <> t2.UIDTIPOTARIFA OR t1.ITIPOTARJETA <> t2.ITIPOTARJETA
) src
ON (dest.UIDMONEDERO = src.UIDMONEDERO)
WHEN MATCHED THEN
    UPDATE SET dest.UIDTIPOTARIFA = src.UIDTIPOTARIFA,
     dest.ITIPOTARJETA = src.ITIPOTARJETA 


commit;








-- DIFERENCIAS SIDAPLICACION USUARIOS
SELECT 'APPMONEDERO COMMAND' REFERENCIA, COUNT(0) DIFERENCIA FROM APP.USUARIO T1
INNER JOIN APPMONEDEROCOMMAND.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
UNION ALL
SELECT 'APPMONEDERO QUERY' REFERENCIA, COUNT(0) DIFERENCIA FROM APP.USUARIO T1
INNER JOIN APPMONEDEROQUERY.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
UNION ALL
SELECT 'APPTICKETS' REFERENCIA, COUNT(0) DIFERENCIA FROM APP.USUARIO T1
INNER JOIN APPTICKETS.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
UNION ALL
SELECT 'NOTIFICACIONES' REFERENCIA, COUNT(0) DIFERENCIA FROM APP.USUARIO T1
INNER JOIN NOTIFICACIONES.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION




-- ACTUALIZAR SIDAPLICACION APPMONEDEROCOMMAND
MERGE INTO APPMONEDEROCOMMAND.USUARIO dest
USING (
    SELECT T1.UIDUSUARIO, T1.SIDAPLICACION
        FROM APP.USUARIO T1
		INNER JOIN APPMONEDEROCOMMAND.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
	WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
) src
ON (dest.UIDUSUARIO = src.UIDUSUARIO)
WHEN MATCHED THEN
    UPDATE SET dest.SIDAPLICACION = src.SIDAPLICACION
commit;

-- ACTUALIZAR SIDAPLICACION APPMONEDEROQUERY
MERGE INTO APPMONEDEROQUERY.USUARIO dest
USING (
    SELECT T1.UIDUSUARIO, T1.SIDAPLICACION
        FROM APP.USUARIO T1
		INNER JOIN APPMONEDEROQUERY.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
	WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
) src
ON (dest.UIDUSUARIO = src.UIDUSUARIO)
WHEN MATCHED THEN
    UPDATE SET dest.SIDAPLICACION = src.SIDAPLICACION
commit;

-- ACTUALIZAR SIDAPLICACION APPTICKETS
MERGE INTO APPTICKETS.USUARIO dest
USING (
    SELECT T1.UIDUSUARIO, T1.SIDAPLICACION
        FROM APP.USUARIO T1
		INNER JOIN APPTICKETS.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
	WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
) src
ON (dest.UIDUSUARIO = src.UIDUSUARIO)
WHEN MATCHED THEN
    UPDATE SET dest.SIDAPLICACION = src.SIDAPLICACION
commit;

-- ACTUALIZAR SIDAPLICACION NOTIFICACIONES
MERGE INTO NOTIFICACIONES.USUARIO dest
USING (
    SELECT T1.UIDUSUARIO, T1.SIDAPLICACION
        FROM APP.USUARIO T1
		INNER JOIN NOTIFICACIONES.USUARIO T2 ON T1.UIDUSUARIO = T2.UIDUSUARIO
	WHERE T1.SIDAPLICACION <> T2.SIDAPLICACION
) src
ON (dest.UIDUSUARIO = src.UIDUSUARIO)
WHEN MATCHED THEN
    UPDATE SET dest.SIDAPLICACION = src.SIDAPLICACION

commit;







select * from MONEDEROCOMANDOS.MONEDERO
    ;
select * from APPMONEDEROQUERY.ESTADODECUENTA


;
   SELECT MM.uidmonedero,
      MM.UIDTIPOSMONEDERO,
      AMM.uidmonedero,
            AMM.uidtipomonedero
   FROM
      MONEDEROCOMANDOS.MONEDERO MM
   left join APPMONEDEROQUERY.ESTADODECUENTA AMM on MM.UIDMONEDERO = AMM.UIDMONEDERO
   where
   MM.BACTIVO = 1 and MM.BBAJA = 0  
   AND (AMM.UIDTIPOMONEDERO is null or MM.UIDTIPOSMONEDERO <> AMM.UIDTIPOMONEDERO)
   and AMM.uidmonedero is not null




MERGE INTO APPMONEDEROQUERY.ESTADODECUENTA e USING (
   SELECT
      MM.uidmonedero,
      MM.UIDTIPOSMONEDERO
   FROM
      MONEDEROCOMANDOS.MONEDERO MM
   left join APPMONEDEROQUERY.ESTADODECUENTA AMM on MM.UIDMONEDERO = AMM.UIDMONEDERO
   where AMM.UIDTIPOMONEDERO is null or MM.UIDTIPOSMONEDERO <> AMM.UIDTIPOMONEDERO
      --   where bInsertadoMovimientos= 1 and bInsertadoEstado = 1
) datos ON (e.uidmonedero = datos.uidmonedero) WHEN MATCHED THEN
UPDATE
SET
   e.UIDTIPOMONEDERO =  datos.UIDTIPOSMONEDERO;
-- Confirmar la transacción completa
COMMIT;





select UIDESTATUS,
       case
           when UIDESTATUS = 'e49098ec-93d6-4a62-a40c-61f73d53b383' then 'EstatusBloq'
           when UIDESTATUS = '5e879806-6e1d-4d5b-9610-25f2a681b637' then 'EstatusActv'
           when UIDESTATUS = '0760fd5f-4039-4c7c-b915-4f0a9c4d4bdc' then 'EstatusBaja'
           else 'otro'
           end   estatus,
       count(1),
       'DEV' as ambiente
from app.ESTADODECUENTA
group by UIDESTATUS,
         case
             when UIDESTATUS = 'e49098ec-93d6-4a62-a40c-61f73d53b383' then 'EstatusBloq'
             when UIDESTATUS = '5e879806-6e1d-4d5b-9610-25f2a681b637' then 'EstatusActv'
             when UIDESTATUS = '0760fd5f-4039-4c7c-b915-4f0a9c4d4bdc' then 'EstatusBaja'
             else 'otro'
             end




MERGE INTO estatusmonedero.motivo r
USING (
    SELECT uidMotivo,
           sMotivo,
           bPermitirOperaciones,
           bPermitirReactivar
     FROM catalogos.motivos
     WHERE iModulo IN (500, 200)
       AND bActivo = 1
       AND bBaja = 0
) p
   ON (r.uidMotivo = p.uidMotivo)
WHEN NOT MATCHED THEN
   INSERT (uidMotivo, sNombre, bPermitirOperaciones, bPermitirReactivar)
   VALUES (p.uidMotivo, p.sMotivo, p.bPermitirOperaciones, p.bPermitirReactivar);


commit;




---------------------------------------------------------










select t1.UIDOPERACION                       as uidTraspaso,
                          t1.DMONTO                             as traspasoMonto,
                          t2.UIDOPERACION                       as origenUId,
                          t2.DSALDOACTUAL                       as origenSaldoDespues,
                          t2.DSALDOANTERIOR                     as origenSaldoAntes,
                          (t2.DSALDOANTERIOR - t2.DSALDOACTUAL) as OrigenSaldoMovido,
                          X.UIDOPERACION                        as destinoUID,
                          X.DSALDOACTUAL                        as destinoSaldoDespues,
                          X.DSALDOANTERIOR                      as destinoSaldoAntes,
                          (X.DSALDOACTUAL - X.DSALDOANTERIOR)   as DestinoSaldoMovido,
                          case
                              when t1.DMONTO = (t2.DSALDOANTERIOR - t2.DSALDOACTUAL) THEN 1
                              ELSE 0 END                        AS bOrigenDebitado,
                          case
                              when t1.DMONTO = (X.DSALDOACTUAL - X.DSALDOANTERIOR) THEN 1
                              ELSE 0 END                        AS bDestinoAbonado
                   from APPMONEDEROCOMMAND.TRASPASOS T1
                            LEFT JOIN MONEDEROCONSULTAS.MOVIMIENTOS T2
                                      ON T2.UIDOPERACION = T1.UIDOPERACION and t2.INUMMONEDERO = t1.INUMEROTARJETAORIGEN
                            LEFT JOIN (select MMM.UIDOPERACION, MME.INUMTARJETA, MMM.DSALDOACTUAL, MMM.DSALDOANTERIOR
                                       from MONEDEROCONSULTAS.MOVIMIENTOS MMM
                                                join monederoconsultas.ESTADODECUENTA MME
                                                     on MMM.INUMMONEDERO = MME.INUMMONEDERO) X
                                      on X.UIDOPERACION = t1.UIDOPERACION AND X.INUMTARJETA = t1.INUMEROTARJETADESTINO




select * from APPMONEDEROCOMMAND.TRASPASOS




with baseDatos as (select t1.UIDOPERACION                       as uidTraspaso,
                          t1.DMONTO                             as traspasoMonto,
                          t2.UIDOPERACION                       as origenUId,
                          t2.DSALDOACTUAL                       as origenSaldoDespues,
                          t2.DSALDOANTERIOR                     as origenSaldoAntes,
                          (t2.DSALDOANTERIOR - t2.DSALDOACTUAL) as OrigenSaldoMovido,
                          X.UIDOPERACION                        as destinoUID,
                          X.DSALDOACTUAL                        as destinoSaldoDespues,
                          X.DSALDOANTERIOR                      as destinoSaldoAntes,
                          (X.DSALDOACTUAL - X.DSALDOANTERIOR)   as DestinoSaldoMovido,
                          case
                              when t1.DMONTO = (t2.DSALDOANTERIOR - t2.DSALDOACTUAL) THEN 1
                              ELSE 0 END                        AS bOrigenDebitado,
                          case
                              when t1.DMONTO = (X.DSALDOACTUAL - X.DSALDOANTERIOR) THEN 1
                              ELSE 0 END                        AS bDestinoAbonado
                   from APPMONEDEROCOMMAND.TRASPASOS T1
                            LEFT JOIN MONEDEROCONSULTAS.MOVIMIENTOS T2
                                      ON T2.UIDOPERACION = T1.UIDOPERACION and t2.INUMMONEDERO = t1.INUMEROTARJETAORIGEN
                            LEFT JOIN (select MMM.UIDOPERACION, MME.INUMTARJETA, MMM.DSALDOACTUAL, MMM.DSALDOANTERIOR
                                       from MONEDEROCONSULTAS.MOVIMIENTOS MMM
                                                join monederoconsultas.ESTADODECUENTA MME
                                                     on MMM.INUMMONEDERO = MME.INUMMONEDERO) X
                                      on X.UIDOPERACION = t1.UIDOPERACION AND X.INUMTARJETA = t1.INUMEROTARJETADESTINO)
select *
from baseDatos
where bOrigenDebitado = 0
   or bDestinoAbonado = 0




























------------------



conn SEGURIDAD/SEGURIDAD$
